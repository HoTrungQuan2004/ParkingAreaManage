<!DOCTYPE html>
<html>
<head>
    <title>Smart Parking Management System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1> Smart Parking Management System</h1>
            <div class="last-updated" id="lastUpdated">Last Updated: --</div>
            <button onclick="refreshData()" style="margin-top: 10px; padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer;">üîÑ Refresh Data</button>
        </header>

        <!-- Parking Statistics Dashboard -->
        <div class="dashboard">
            <div class="stat-card total">
                <h3>Total Slots</h3>
                <div class="stat-number" id="totalSlots">--</div>
            </div>
            <div class="stat-card occupied">
                <h3>Occupied</h3>
                <div class="stat-number" id="occupiedSlots">--</div>
            </div>
            <div class="stat-card available">
                <h3>Available</h3>
                <div class="stat-number" id="availableSlots">--</div>
            </div>
            <div class="stat-card occupancy">
                <h3>Occupancy Rate</h3>
                <div class="stat-number" id="occupancyRate">--%</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <h3>üìä Daily Vehicle Count (Last 7 Days)</h3>
                <canvas id="dailyChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>üìà Monthly Vehicle Count (Last 6 Months)</h3>
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>

        <!-- Current Vehicles Section -->
        <div class="vehicles-section">
            <h2>üöô Currently Parked Vehicles</h2>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="üîç Search by license plate..." />
            </div>
            <div id="currentVehiclesList" class="vehicles-list"></div>
        </div>

        <!-- Recent Activity Section -->
        <div class="activity-section">
            <h2>üìã Recent Activity</h2>
            <div class="activity-tabs">
                <button class="tab-button active" onclick="showTab('entries')">Recent Entries</button>
                <button class="tab-button" onclick="showTab('exits')">Recent Exits</button>
            </div>
            <div id="recentEntriesList" class="activity-list"></div>
            <div id="recentExitsList" class="activity-list" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Configuration object for the parking system
        const PARKING_CONFIG = {
            TOTAL_SLOTS: 100,
            REFRESH_INTERVAL: 30000, // 30 seconds
            MAX_RECENT_ENTRIES: 50,
            MAX_DISPLAY_ENTRIES: 20,
            CHART_UPDATE_DELAY: 1000,
            FIREBASE_RETRY_DELAY: 2000,
            SAMPLE_DATA_DELAY: 3000
        };

        // Debug function to check Firebase configuration
        function debugFirebaseConfig() {
            console.log('=== Firebase Debug Information ===');
            console.log('Firebase Config:', {
                apiKey: firebaseConfig.apiKey ? '***' + firebaseConfig.apiKey.slice(-4) : 'MISSING',
                authDomain: firebaseConfig.authDomain,
                databaseURL: firebaseConfig.databaseURL,
                projectId: firebaseConfig.projectId
            });
            
            // Check if Firebase scripts loaded
            console.log('Firebase app available:', typeof firebase !== 'undefined');
            console.log('Firebase database available:', typeof firebase?.database === 'function');
            
            // Check network connectivity
            if (navigator.onLine) {
                console.log('Network: Online');
            } else {
                console.log('Network: Offline');
            }
        }

        // Replace with your actual Firebase project configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "Your apiKey",
            authDomain: "yourdomain.firebaseapp.com",
            databaseURL: "Your database URL",
            projectId: "Your project ID",
            storageBucket: "yourstoragebucket.firebasestorage.app",
            messagingSenderId: "YourSenderID",
            appId: "Your appID",
            measurementId: "Your mearsurement ID"
        };

        // Global variables
        let currentVehicles = {};
        let recentEntries = [];
        let recentExits = [];
        let dailyChart, monthlyChart;
        let db; // Firebase database reference

        // Initialize Firebase when DOM is ready
        function initializeFirebase() {
            try {
                updateConnectionStatus('connecting');
                debugFirebaseConfig();
                
                // Check if Firebase is loaded
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK not loaded. Check your internet connection.');
                }
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                console.log('Firebase initialized successfully');
                
                // Test database connection
                db.ref('.info/connected').on('value', function(snapshot) {
                    if (snapshot.val() === true) {
                        console.log('Connected to Firebase Realtime Database');
                        updateConnectionStatus('connected');
                        const lastUpdatedEl = document.querySelector('#lastUpdated');
                        if (lastUpdatedEl) {
                            const statusText = lastUpdatedEl.textContent.replace(/^.*?Last Updated:/, 'Last Updated:');
                            lastUpdatedEl.innerHTML = `<span class="connection-status connected"></span>${statusText || 'Connected - ' + new Date().toLocaleString()}`;
                        }
                    } else {
                        console.log('Disconnected from Firebase Realtime Database');
                        updateConnectionStatus('disconnected');
                        const lastUpdatedEl = document.querySelector('#lastUpdated');
                        if (lastUpdatedEl) {
                            lastUpdatedEl.innerHTML = `<span class="connection-status disconnected"></span>Connection Lost`;
                        }
                    }
                }, function(error) {
                    console.error('Connection monitoring error:', error);
                    updateConnectionStatus('disconnected');
                });
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                updateConnectionStatus('disconnected');
                
                // More specific error messages
                let errorMessage = 'Failed to connect to Firebase. ';
                if (error.message.includes('not loaded')) {
                    errorMessage += 'Firebase SDK failed to load. Check your internet connection.';
                } else if (error.code === 'app/invalid-api-key') {
                    errorMessage += 'Invalid API key in configuration.';
                } else if (error.code === 'app/invalid-app-argument') {
                    errorMessage += 'Invalid Firebase configuration.';
                } else {
                    errorMessage += 'Please check your configuration and internet connection.';
                }
                
                alert(errorMessage);
                
                // Update UI to show error
                const lastUpdatedEl = document.querySelector('#lastUpdated');
                if (lastUpdatedEl) {
                    lastUpdatedEl.innerHTML = `<span class="connection-status disconnected"></span>Firebase connection failed`;
                }
            }
        }

        // DOM elements - Initialize after DOM is ready
        let totalSlotsEl, occupiedSlotsEl, availableSlotsEl, occupancyRateEl;
        let lastUpdatedEl, currentVehiclesListEl, recentEntriesListEl, recentExitsListEl, searchInputEl;

        // Initialize DOM elements
        function initializeDOMElements() {
            totalSlotsEl = document.getElementById('totalSlots');
            occupiedSlotsEl = document.getElementById('occupiedSlots');
            availableSlotsEl = document.getElementById('availableSlots');
            occupancyRateEl = document.getElementById('occupancyRate');
            lastUpdatedEl = document.getElementById('lastUpdated');
            currentVehiclesListEl = document.getElementById('currentVehiclesList');
            recentEntriesListEl = document.getElementById('recentEntriesList');
            recentExitsListEl = document.getElementById('recentExitsList');
            searchInputEl = document.getElementById('searchInput');
            
            console.log('DOM elements initialized:', {
                totalSlots: !!totalSlotsEl,
                occupiedSlots: !!occupiedSlotsEl,
                availableSlots: !!availableSlotsEl,
                occupancyRate: !!occupancyRateEl,
                lastUpdated: !!lastUpdatedEl,
                currentVehiclesList: !!currentVehiclesListEl,
                recentEntriesList: !!recentEntriesListEl,
                recentExitsList: !!recentExitsListEl,
                searchInput: !!searchInputEl
            });
        }

        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            };

            dailyChart = new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: '#2196f3',
                        borderColor: '#1976d2',
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });

            monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderColor: '#2196f3',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        // Update parking statistics
        function updateParkingStats(stats) {
            if (stats && totalSlotsEl && occupiedSlotsEl && availableSlotsEl && occupancyRateEl) {
                totalSlotsEl.textContent = stats.total_slots || 0;
                occupiedSlotsEl.textContent = stats.occupied_slots || 0;
                availableSlotsEl.textContent = stats.available_slots || 0;
                
                const occupancyPercentage = stats.total_slots > 0 
                    ? Math.round((stats.occupied_slots / stats.total_slots) * 100) 
                    : 0;
                occupancyRateEl.textContent = occupancyPercentage + '%';
                
                // Update occupancy rate color based on percentage
                const occupancyCard = document.querySelector('.stat-card.occupancy');
                if (occupancyCard) {
                    occupancyCard.className = 'stat-card occupancy';
                    if (occupancyPercentage >= 90) {
                        occupancyCard.classList.add('critical');
                    } else if (occupancyPercentage >= 70) {
                        occupancyCard.classList.add('warning');
                    }
                }
                
                if (stats.last_updated && lastUpdatedEl) {
                    lastUpdatedEl.textContent = `Last Updated: ${formatDateTime(stats.last_updated)}`;
                    lastUpdatedEl.style.color = '#4caf50';
                }
                
                console.log('Parking stats updated:', stats);
            } else {
                console.warn('Cannot update parking stats - DOM elements or stats data missing');
            }
        }

        // Format date and time
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString();
        }

        // Format date only
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Add current vehicle to list
        function addCurrentVehicle(key, data) {
            currentVehicles[key] = data;
            displayCurrentVehicles();
        }

        // Remove current vehicle from list
        function removeCurrentVehicle(key) {
            if (currentVehicles[key]) {
                // Add to recent exits
                const exitData = {
                    ...currentVehicles[key],
                    exit_time: new Date().toISOString().replace('T', ' ').substr(0, 19)
                };
                recentExits.unshift(exitData);
                if (recentExits.length > 50) recentExits.pop();
                
                delete currentVehicles[key];
                displayCurrentVehicles();
                displayRecentExits();
            }
        }

        // Display current vehicles
        function displayCurrentVehicles() {
            if (!currentVehiclesListEl) {
                console.log('DOM elements not ready for displayCurrentVehicles');
                return;
            }

            const searchTerm = searchInputEl && searchInputEl.value ? searchInputEl.value.toLowerCase() : '';
            const vehicleEntries = Object.entries(currentVehicles);
            
            let filteredVehicles = vehicleEntries;
            if (searchTerm) {
                filteredVehicles = vehicleEntries.filter(([key, data]) =>
                    (data.number_plate && data.number_plate.toLowerCase().includes(searchTerm)) ||
                    (key && key.toLowerCase().includes(searchTerm))
                );
            }

            currentVehiclesListEl.innerHTML = '';
            
            if (filteredVehicles.length === 0) {
                const emptyMessage = searchTerm ? 'No vehicles found matching your search' : 'No vehicles currently parked';
                currentVehiclesListEl.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
                return;
            }

            console.log('Displaying vehicles:', filteredVehicles.length);

            filteredVehicles.forEach(([key, data]) => {
                const vehicleEl = document.createElement('div');
                vehicleEl.className = 'plate current-vehicle';
                
                // Handle different timestamp formats
                let entryTime;
                try {
                    if (data.entry_time) {
                        entryTime = new Date(data.entry_time);
                    } else if (data.date_time) {
                        // Handle ESP32 format "2025-05-23 22:54:54"
                        entryTime = new Date(data.date_time.replace(' ', 'T') + 'Z');
                        if (isNaN(entryTime.getTime())) {
                            entryTime = new Date(data.date_time);
                        }
                    } else if (data.timestamp) {
                        entryTime = new Date(data.timestamp);
                    } else if (data.detected_time) {
                        entryTime = new Date(data.detected_time);
                    }
                    
                    // Validate the parsed date
                    if (!entryTime || isNaN(entryTime.getTime())) {
                        throw new Error('Invalid date');
                    }
                } catch (error) {
                    console.error('Error parsing entry time for vehicle', key, error, {
                        entry_time: data.entry_time,
                        date_time: data.date_time,
                        timestamp: data.timestamp,
                        detected_time: data.detected_time
                    });
                    // Skip this vehicle if no valid timestamp
                    return;
                }
                
                const now = new Date();
                const duration = Math.max(0, Math.floor((now - entryTime) / (1000 * 60))); // minutes
                
                let durationText = '';
                if (duration < 1) {
                    durationText = 'Just arrived';
                } else if (duration < 60) {
                    durationText = `${duration} min`;
                } else if (duration < 1440) {
                    const hours = Math.floor(duration / 60);
                    const mins = duration % 60;
                    durationText = mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
                } else {
                    const days = Math.floor(duration / 1440);
                    const hours = Math.floor((duration % 1440) / 60);
                    durationText = hours > 0 ? `${days}d ${hours}h` : `${days}d`;
                }
                
                const plateNumber = data.number_plate || key;
                const formattedEntryTime = entryTime.toLocaleString();
                
                vehicleEl.innerHTML = `
                    <div class="vehicle-info">
                        <div class="plate-number">üöó ${plateNumber}</div>
                        <div class="vehicle-details">
                            <span class="entry-time">üìÖ Entered: ${formattedEntryTime}</span>
                            <span class="duration">‚è±Ô∏è Duration: ${durationText}</span>
                        </div>
                    </div>
                    ${data.image ? `<div class="vehicle-image"><img src="data:image/jpeg;base64,${data.image}" alt="Vehicle Image" onclick="showImageModal(this.src)" style="max-width: 100px; max-height: 100px; cursor: pointer; border-radius: 5px;"></div>` : ''}
                `;
                
                currentVehiclesListEl.appendChild(vehicleEl);
            });
        }

        // Display recent entries
        function displayRecentEntries() {
            if (!recentEntriesListEl) {
                console.log('recentEntriesListEl not ready');
                return;
            }

            recentEntriesListEl.innerHTML = '';
            
            if (recentEntries.length === 0) {
                recentEntriesListEl.innerHTML = '<div class="empty-state">No recent entries</div>';
                return;
            }

            // Sort entries by time (newest first)
            const sortedEntries = [...recentEntries].sort((a, b) => {
                const timeA = new Date(a.entry_time || a.timestamp || a.detected_time || 0);
                const timeB = new Date(b.entry_time || b.timestamp || b.detected_time || 0);
                return timeB - timeA;
            });

            sortedEntries.slice(0, 20).forEach(data => {
                if (data && (data.number_plate || data.key)) {
                    const entryEl = document.createElement('div');
                    entryEl.className = 'plate activity-entry';
                    
                    const plateNumber = data.number_plate || data.key || 'Unknown';
                    
                    // Handle different timestamp formats
                    let entryTime;
                    try {
                        if (data.entry_time) {
                            entryTime = new Date(data.entry_time);
                        } else if (data.date_time) {
                            // Handle ESP32 format "2025-05-23 22:54:54"
                            entryTime = new Date(data.date_time.replace(' ', 'T') + 'Z');
                            if (isNaN(entryTime.getTime())) {
                                entryTime = new Date(data.date_time);
                            }
                        } else if (data.timestamp) {
                            entryTime = new Date(data.timestamp);
                        } else if (data.detected_time) {
                            entryTime = new Date(data.detected_time);
                        }
                        
                        // Validate the parsed date
                        if (!entryTime || isNaN(entryTime.getTime())) {
                            throw new Error('Invalid date');
                        }
                    } catch (error) {
                        console.error('Error parsing entry time for recent entry:', error, data);
                        return; // Skip this entry if no valid timestamp
                    }
                    
                    entryEl.innerHTML = `
                        <div class="activity-info">
                            <div class="plate-number">üü¢ ${plateNumber}</div>
                            <div class="activity-time">üìÖ ${entryTime.toLocaleString()}</div>
                            <div class="activity-status">Status: Vehicle Entered</div>
                        </div>
                    `;
                    recentEntriesListEl.appendChild(entryEl);
                }
            });
        }

        // Display recent exits
        function displayRecentExits() {
            if (!recentExitsListEl) {
                console.log('recentExitsListEl not ready');
                return;
            }

            recentExitsListEl.innerHTML = '';
            
            if (recentExits.length === 0) {
                recentExitsListEl.innerHTML = '<div class="empty-state">No recent exits</div>';
                return;
            }

            recentExits.slice(0, 20).forEach(data => {
                if (data && data.number_plate && data.exit_time) {
                    const exitEl = document.createElement('div');
                    exitEl.className = 'plate activity-exit';
                    exitEl.innerHTML = `
                        <div class="activity-info">
                            <div class="plate-number">üî¥ ${data.number_plate}</div>
                            <div class="activity-time">üìÖ ${formatDateTime(data.exit_time)}</div>
                            <div class="activity-status">Status: Vehicle Exited</div>
                        </div>
                    `;
                    recentExitsListEl.appendChild(exitEl);
                }
            });
        }

        // Update daily chart
        function updateDailyChart(dailyData) {
            const last7Days = [];
            const counts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
                
                // Check if data exists for this date
                const dayData = dailyData && dailyData[dateStr] ? dailyData[dateStr].count : 0;
                counts.push(dayData);
            }
            
            console.log('Updating daily chart with:', { labels: last7Days, data: counts });
            
            if (dailyChart) {
                dailyChart.data.labels = last7Days;
                dailyChart.data.datasets[0].data = counts;
                dailyChart.update();
            }
        }

        // Update monthly chart
        function updateMonthlyChart(monthlyData) {
            const last6Months = [];
            const counts = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthStr = date.toISOString().substr(0, 7);
                last6Months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
                
                // Check if data exists for this month
                const monthData = monthlyData && monthlyData[monthStr] ? monthlyData[monthStr].count : 0;
                counts.push(monthData);
            }
            
            console.log('Updating monthly chart with:', { labels: last6Months, data: counts });
            
            if (monthlyChart) {
                monthlyChart.data.labels = last6Months;
                monthlyChart.data.datasets[0].data = counts;
                monthlyChart.update();
            }
        }

        // Show tab
        function showTab(tab) {
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('recentEntriesList').style.display = 'none';
            document.getElementById('recentExitsList').style.display = 'none';
            
            if (tab === 'entries') {
                document.getElementById('recentEntriesList').style.display = 'block';
                buttons[0].classList.add('active');
            } else {
                document.getElementById('recentExitsList').style.display = 'block';
                buttons[1].classList.add('active');
            }
        }

        // Show image modal
        function showImageModal(src) {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <img src="${src}" alt="Vehicle Image">
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Manual refresh function for testing
        function refreshData() {
            console.log('Manually refreshing data...');
            
            if (!db) {
                console.error('Database not initialized for refresh');
                alert('Database not connected. Please check your Firebase configuration.');
                return;
            }
            
            // Show loading state
            const refreshButton = event.target;
            const originalText = refreshButton.innerHTML;
            refreshButton.innerHTML = 'üîÑ Refreshing...';
            refreshButton.disabled = true;
            
            // Refresh all data from Firebase
            loadInitialData();
            
            // Reset button after 2 seconds
            setTimeout(() => {
                refreshButton.innerHTML = originalText;
                refreshButton.disabled = false;
                
                // Update last updated time
                const lastUpdatedEl = document.getElementById('lastUpdated');
                if (lastUpdatedEl && !lastUpdatedEl.textContent.includes('Failed')) {
                    lastUpdatedEl.textContent = `Last Updated: ${new Date().toLocaleString()}`;
                }
                
                console.log('Data refresh completed');
            }, 2000);
        }

        // Initialize the application
        function init() {
            console.log('Initializing Smart Parking Management System...');
            
            // Initialize Firebase first
            initializeFirebase();
            
            // Initialize charts
            initCharts();
            
            // Setup search functionality after DOM is ready
            if (searchInputEl) {
                searchInputEl.addEventListener('input', displayCurrentVehicles);
                console.log('Search functionality initialized');
            } else {
                console.warn('Search input element not found');
            }
            
            // Test Firebase connection and setup listeners after initialization
            setTimeout(() => {
                testFirebaseConnection();
                setupFirebaseListeners();
            }, 1500);
            
            // Initialize sample data if needed (for demo purposes)
            setTimeout(() => {
                initializeSampleData();
            }, 3000);
            
            // Auto-refresh data every 30 seconds
            setInterval(() => {
                if (db) {
                    updateParkingStatsFromNumberplate();
                    updateChartsFromNumberplate();
                }
            }, 30000);
            
            // Update timestamp display every minute
            setInterval(() => {
                const now = new Date();
                const lastUpdatedEl = document.getElementById('lastUpdated');
                if (lastUpdatedEl && !lastUpdatedEl.textContent.includes('Failed') && !lastUpdatedEl.textContent.includes('connection failed')) {
                    if (!lastUpdatedEl.textContent.includes('Connected to Firebase')) {
                        lastUpdatedEl.textContent = `Last Updated: ${now.toLocaleString()}`;
                    }
                }
            }, 60000);
            
            console.log('Application initialization completed');
        }

        // Clear sample data function
        function clearSampleDataIfNeeded() {
            if (!db) return;
            
            // Check if we have sample data patterns
            db.ref('numberplate').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    const keys = Object.keys(data);
                    const sampleKeys = ['sample-001', 'sample-002', 'sample-003', 'sample-004'];
                    const hasSampleData = sampleKeys.some(sampleKey => keys.includes(sampleKey));
                    
                    if (hasSampleData && keys.length > sampleKeys.length) {
                        console.log('Real data detected, clearing sample data...');
                        // Remove sample data
                        sampleKeys.forEach(sampleKey => {
                            if (data[sampleKey]) {
                                db.ref(`numberplate/${sampleKey}`).remove();
                            }
                        });
                    }
                }
            }).catch(error => {
                console.error('Error checking for sample data:', error);
            });
        }

        // Firebase listeners
        function setupFirebaseListeners() {
            if (!db) {
                console.error('Database not initialized');
                return;
            }

            try {
                // Listen for new numberplate entries
                db.ref('numberplate').on('child_added', snapshot => {
                    console.log('New numberplate detected:', snapshot.key, snapshot.val());
                    const recordId = snapshot.key; // Firebase auto-generated ID
                    const data = snapshot.val();
                    
                    // Log the raw data for debugging
                    console.log('Raw ESP32 data:', {
                        recordId: recordId,
                        date_time: data.date_time,
                        number_plate: data.number_plate,
                        fullData: data
                    });
                    
                    // Handle ESP32 data structure - use the actual format
                    const plateNumber = data.number_plate;
                    const timestamp = data.date_time;
                    
                    if (!plateNumber || !timestamp) {
                        console.warn('Missing required data - plate:', plateNumber, 'timestamp:', timestamp);
                        return;
                    }
                    
                    // Convert date_time format to proper timestamp
                    let entryTime;
                    try {
                        // Handle "2025-05-23 22:54:54" format
                        entryTime = new Date(timestamp.replace(' ', 'T') + 'Z'); // Add 'Z' for UTC
                        if (isNaN(entryTime.getTime())) {
                            entryTime = new Date(timestamp); // Try direct parsing
                        }
                    } catch (error) {
                        console.error('Error parsing date_time:', timestamp, error);
                        return;
                    }
                    
                    const entryData = {
                        recordId: recordId,
                        number_plate: plateNumber,
                        entry_time: entryTime.toISOString(),
                        date_time: timestamp,
                        timestamp: entryTime.toISOString(),
                        detected_time: entryTime.toISOString(),
                        image: data.image || null
                    };
                    
                    console.log('Processed entry data:', entryData);
                    
                    // Clear sample data if real data is coming in
                    clearSampleDataIfNeeded();
                    
                    // Use recordId as key since multiple vehicles can have same plate
                    addCurrentVehicle(recordId, entryData);
                    
                    // Add to recent entries
                    recentEntries.unshift(entryData);
                    if (recentEntries.length > 50) recentEntries.pop();
                    
                    // Update displays
                    displayRecentEntries();
                    updateParkingStatsFromNumberplate();
                    updateChartsFromNumberplate();
                    
                    console.log('Vehicle added to parking:', plateNumber);
                }, error => {
                    console.error('Error reading numberplate entries:', error);
                });

                // Listen for numberplate data changes
                db.ref('numberplate').on('child_changed', snapshot => {
                    console.log('Numberplate data updated:', snapshot.key, snapshot.val());
                    const recordId = snapshot.key;
                    const data = snapshot.val();
                    
                    // Update existing vehicle data using recordId
                    if (currentVehicles[recordId]) {
                        const plateNumber = data.number_plate;
                        const timestamp = data.date_time;
                        
                        if (plateNumber && timestamp) {
                            let entryTime;
                            try {
                                entryTime = new Date(timestamp.replace(' ', 'T') + 'Z');
                                if (isNaN(entryTime.getTime())) {
                                    entryTime = new Date(timestamp);
                                }
                            } catch (error) {
                                console.error('Error parsing updated date_time:', timestamp, error);
                                return;
                            }
                            
                            currentVehicles[recordId] = {
                                recordId: recordId,
                                number_plate: plateNumber,
                                entry_time: entryTime.toISOString(),
                                date_time: timestamp,
                                timestamp: entryTime.toISOString(),
                                detected_time: entryTime.toISOString(),
                                image: data.image || null
                            };
                            displayCurrentVehicles();
                        }
                    }
                }, error => {
                    console.error('Error on numberplate data change:', error);
                });

                // Listen for numberplate removals (vehicle exits)
                db.ref('numberplate').on('child_removed', snapshot => {
                    console.log('Vehicle exited:', snapshot.key);
                    removeCurrentVehicle(snapshot.key); // Use recordId
                    updateParkingStatsFromNumberplate();
                    updateChartsFromNumberplate();
                }, error => {
                    console.error('Error on numberplate removal:', error);
                });

                // Initial data load
                loadInitialData();

                console.log('Firebase listeners set up successfully for numberplate folder');
            } catch (error) {
                console.error('Error setting up Firebase listeners:', error);
            }
        }

        // Load initial data from Firebase
        function loadInitialData() {
            if (!db) return;
            
            console.log('Loading initial data from Firebase...');
            
            db.ref('numberplate').once('value').then(snapshot => {
                const data = snapshot.val();
                console.log('Initial numberplate data loaded:', data);
                
                if (data) {
                    // Clear existing data
                    currentVehicles = {};
                    recentEntries = [];
                    
                    // Process each vehicle
                    Object.entries(data).forEach(([recordId, vehicleData]) => {
                        // Handle the ESP32 format: recordId -> {date_time, number_plate}
                        const plateNumber = vehicleData.number_plate;
                        const timestamp = vehicleData.date_time;
                        
                        if (!plateNumber || !timestamp) {
                            console.warn('Skipping record with missing data:', recordId, vehicleData);
                            return;
                        }
                        
                        // Convert date_time format to proper timestamp
                        let entryTime;
                        try {
                            entryTime = new Date(timestamp.replace(' ', 'T') + 'Z');
                            if (isNaN(entryTime.getTime())) {
                                entryTime = new Date(timestamp);
                            }
                            if (isNaN(entryTime.getTime())) {
                                throw new Error('Invalid date format');
                            }
                        } catch (error) {
                            console.error('Error parsing date_time for record:', recordId, timestamp, error);
                            return;
                        }
                        
                        const entryData = {
                            recordId: recordId,
                            number_plate: plateNumber,
                            entry_time: entryTime.toISOString(),
                            date_time: timestamp,
                            timestamp: entryTime.toISOString(),
                            detected_time: entryTime.toISOString(),
                            image: vehicleData.image || null
                        };
                        
                        // Add to current vehicles using recordId as key
                        currentVehicles[recordId] = entryData;
                        
                        // Add to recent entries
                        recentEntries.push(entryData);
                    });
                    
                    // Sort recent entries by time (newest first)
                    recentEntries.sort((a, b) => new Date(b.entry_time) - new Date(a.entry_time));
                    
                    // Update all displays
                    displayCurrentVehicles();
                    displayRecentEntries();
                    updateParkingStatsFromNumberplate();
                    updateChartsFromNumberplate();
                    
                    console.log('Initial data loaded successfully. Current vehicles:', Object.keys(currentVehicles).length);
                } else {
                    console.log('No initial data found in numberplate folder');
                    // Initialize empty displays
                    displayCurrentVehicles();
                    displayRecentEntries();
                    updateParkingStatsFromNumberplate();
                    updateChartsFromNumberplate();
                }
            }).catch(error => {
                console.error('Error loading initial data:', error);
            });
        }

        // Update parking statistics based on numberplate data
        function updateParkingStatsFromNumberplate() {
            if (!db) {
                console.error('Database not initialized');
                return;
            }

            db.ref('numberplate').once('value').then(snapshot => {
                const numberplateData = snapshot.val();
                const occupiedSlots = numberplateData ? Object.keys(numberplateData).length : 0;
                const totalSlots = PARKING_CONFIG.TOTAL_SLOTS; // Configurable total slot count
                const availableSlots = Math.max(0, totalSlots - occupiedSlots);
                
                console.log('Updating parking stats:', {
                    total: totalSlots,
                    occupied: occupiedSlots,
                    available: availableSlots
                });

                updateParkingStats({
                    total_slots: totalSlots,
                    occupied_slots: occupiedSlots,
                    available_slots: availableSlots,
                    last_updated: new Date().toISOString()
                });
            }).catch(error => {
                console.error('Error updating parking stats from numberplate:', error);
                // Show default values on error
                updateParkingStats({
                    total_slots: PARKING_CONFIG.TOTAL_SLOTS,
                    occupied_slots: 0,
                    available_slots: PARKING_CONFIG.TOTAL_SLOTS,
                    last_updated: new Date().toISOString()
                });
            });
        }

        // Update charts based on numberplate data
        function updateChartsFromNumberplate() {
            updateDailyChartFromNumberplate();
            updateMonthlyChartFromNumberplate();
        }

        // Update daily chart based on numberplate data
        function updateDailyChartFromNumberplate() {
            if (!db) {
                console.error('Database not initialized');
                return;
            }

            db.ref('numberplate').once('value').then(snapshot => {
                const numberplateData = snapshot.val();
                const dailyCounts = {};

                if (numberplateData) {
                    Object.values(numberplateData).forEach(data => {
                        // Handle ESP32 format with date_time field
                        let entryTime;
                        try {
                            if (data.date_time) {
                                // Convert "2025-05-23 22:54:54" to proper Date
                                entryTime = new Date(data.date_time.replace(' ', 'T') + 'Z');
                                if (isNaN(entryTime.getTime())) {
                                    entryTime = new Date(data.date_time);
                                }
                            } else if (data.timestamp) {
                                entryTime = new Date(data.timestamp);
                            } else if (data.entry_time) {
                                entryTime = new Date(data.entry_time);
                            } else if (data.detected_time) {
                                entryTime = new Date(data.detected_time);
                            }
                            
                            // Validate the parsed date
                            if (!entryTime || isNaN(entryTime.getTime())) {
                                console.warn('Invalid timestamp in daily chart data:', data);
                                return;
                            }
                        } catch (error) {
                            console.error('Error parsing timestamp for daily chart:', error, data);
                            return;
                        }
                        
                        const entryDate = entryTime.toISOString().split('T')[0];
                        dailyCounts[entryDate] = (dailyCounts[entryDate] || { count: 0 });
                        dailyCounts[entryDate].count = (dailyCounts[entryDate].count || 0) + 1;
                    });
                }

                console.log('Daily counts for chart:', dailyCounts);
                updateDailyChart(dailyCounts);
            }).catch(error => {
                console.error('Error updating daily chart from numberplate:', error);
                updateDailyChart({});
            });
        }

        // Update monthly chart based on numberplate data
        function updateMonthlyChartFromNumberplate() {
            if (!db) {
                console.error('Database not initialized');
                return;
            }

            db.ref('numberplate').once('value').then(snapshot => {
                const numberplateData = snapshot.val();
                const monthlyCounts = {};

                if (numberplateData) {
                    Object.values(numberplateData).forEach(data => {
                        // Handle ESP32 format with date_time field
                        let entryTime;
                        try {
                            if (data.date_time) {
                                // Convert "2025-05-23 22:54:54" to proper Date
                                entryTime = new Date(data.date_time.replace(' ', 'T') + 'Z');
                                if (isNaN(entryTime.getTime())) {
                                    entryTime = new Date(data.date_time);
                                }
                            } else if (data.timestamp) {
                                entryTime = new Date(data.timestamp);
                            } else if (data.entry_time) {
                                entryTime = new Date(data.entry_time);
                            } else if (data.detected_time) {
                                entryTime = new Date(data.detected_time);
                            }
                            
                            // Validate the parsed date
                            if (!entryTime || isNaN(entryTime.getTime())) {
                                console.warn('Invalid timestamp in monthly chart data:', data);
                                return;
                            }
                        } catch (error) {
                            console.error('Error parsing timestamp for monthly chart:', error, data);
                            return;
                        }
                        
                        const entryMonth = entryTime.toISOString().substr(0, 7);
                        monthlyCounts[entryMonth] = (monthlyCounts[entryMonth] || { count: 0 });
                        monthlyCounts[entryMonth].count = (monthlyCounts[entryMonth].count || 0) + 1;
                    });
                }

                console.log('Monthly counts for chart:', monthlyCounts);
                updateMonthlyChart(monthlyCounts);
            }).catch(error => {
                console.error('Error updating monthly chart from numberplate:', error);
                updateMonthlyChart({});
            });
        }

        // Show tab
        function showTab(tab) {
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('recentEntriesList').style.display = 'none';
            document.getElementById('recentExitsList').style.display = 'none';
            
            if (tab === 'entries') {
                document.getElementById('recentEntriesList').style.display = 'block';
                buttons[0].classList.add('active');
            } else {
                document.getElementById('recentExitsList').style.display = 'block';
                buttons[1].classList.add('active');
            }
        }

        // Show image modal
        function showImageModal(src) {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <img src="${src}" alt="Vehicle Image">
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Manual refresh function for testing
        function refreshData() {
            console.log('Manually refreshing data...');
            
            if (!db) {
                console.error('Database not initialized for refresh');
                alert('Database not connected. Please check your Firebase configuration.');
                return;
            }
            
            // Show loading state
            const refreshButton = event.target;
            const originalText = refreshButton.innerHTML;
            refreshButton.innerHTML = 'üîÑ Refreshing...';
            refreshButton.disabled = true;
            
            // Refresh all data from Firebase
            loadInitialData();
            
            // Reset button after 2 seconds
            setTimeout(() => {
                refreshButton.innerHTML = originalText;
                refreshButton.disabled = false;
                
                // Update last updated time
                const lastUpdatedEl = document.getElementById('lastUpdated');
                if (lastUpdatedEl && !lastUpdatedEl.textContent.includes('Failed')) {
                    lastUpdatedEl.textContent = `Last Updated: ${new Date().toLocaleString()}`;
                }
                
                console.log('Data refresh completed');
            }, 2000);
        }

        // Initialize the application
        function init() {
            console.log('Initializing Smart Parking Management System...');
            
            // Initialize Firebase first
            initializeFirebase();
            
            // Initialize charts
            initCharts();
            
            // Setup search functionality after DOM is ready
            if (searchInputEl) {
                searchInputEl.addEventListener('input', displayCurrentVehicles);
                console.log('Search functionality initialized');
            } else {
                console.warn('Search input element not found');
            }
            
            // Test Firebase connection and setup listeners after initialization
            setTimeout(() => {
                testFirebaseConnection();
                setupFirebaseListeners();
            }, 1500);
            
            // Initialize sample data if needed (for demo purposes)
            setTimeout(() => {
                initializeSampleData();
            }, 3000);
            
            // Auto-refresh data every 30 seconds
            setInterval(() => {
                if (db) {
                    updateParkingStatsFromNumberplate();
                    updateChartsFromNumberplate();
                }
            }, 30000);
            
            // Update timestamp display every minute
            setInterval(() => {
                const now = new Date();
                const lastUpdatedEl = document.getElementById('lastUpdated');
                if (lastUpdatedEl && !lastUpdatedEl.textContent.includes('Failed') && !lastUpdatedEl.textContent.includes('connection failed')) {
                    if (!lastUpdatedEl.textContent.includes('Connected to Firebase')) {
                        lastUpdatedEl.textContent = `Last Updated: ${now.toLocaleString()}`;
                    }
                }
            }, 60000);
            
            console.log('Application initialization completed');
        }

        // Test Firebase connection
        function testFirebaseConnection() {
            if (!db) {
                console.error('Database not initialized for testing');
                return;
            }

            console.log('Testing Firebase connection...');
            
            // Test read access to a simple path
            db.ref('.info/serverTimeOffset').once('value')
                .then(snapshot => {
                    console.log('Firebase read test successful, server time offset:', snapshot.val());
                    console.log('Testing database rules...');
                    
                    // Try to read the root to test permissions
                    return db.ref('/').limitToFirst(1).once('value');
                })
                .then(snapshot => {
                    console.log('Database rules test successful');
                    
                    // Update UI to show connection is working
                    const lastUpdatedEl = document.getElementById('lastUpdated');
                    if (lastUpdatedEl) {
                        lastUpdatedEl.textContent = 'Connected to Firebase - ' + new Date().toLocaleString();
                        lastUpdatedEl.style.color = '#4caf50';
                    }
                })
                .catch(error => {
                    console.error('Firebase connection test failed:', error);
                    
                    let errorMsg = 'Firebase connection failed: ';
                    if (error.code === 'PERMISSION_DENIED') {
                        errorMsg += 'Database rules deny access. Please check your Firebase security rules.';
                        console.error('SOLUTION: Go to Firebase Console > Realtime Database > Rules and set:');
                        console.error('{"rules": {".read": true, ".write": true}}');
                    } else if (error.code === 'NETWORK_ERROR') {
                        errorMsg += 'Network error. Check your internet connection.';
                    } else {
                        errorMsg += error.message;
                    }
                    
                    const lastUpdatedEl = document.getElementById('lastUpdated');
                    if (lastUpdatedEl) {
                        lastUpdatedEl.textContent = errorMsg;
                        lastUpdatedEl.style.color = '#f44336';
                    }
                });
        }

        // Initialize sample data for testing (if no real data exists)
        function initializeSampleData() {
            if (!db) return;

            console.log('Checking if sample data initialization is needed...');

            // Check if real data exists
            db.ref('numberplate').once('value').then(snapshot => {
                if (!snapshot.exists() || Object.keys(snapshot.val() || {}).length === 0) {
                    console.log('No real data found, initializing sample data for demonstration...');

                    // Create sample data matching ESP32 format
                    const now = new Date();
                    const sampleNumberplateData = {
                        'sample-001': {
                            date_time: new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString().replace('T', ' ').replace('Z', '').split('.')[0], // 2 hours ago
                            number_plate: 'ABC-123'
                        },
                        'sample-002': {
                            date_time: new Date(now.getTime() - 45 * 60 * 1000).toISOString().replace('T', ' ').replace('Z', '').split('.')[0], // 45 minutes ago  
                            number_plate: 'XYZ-789'
                        },
                        'sample-003': {
                            date_time: new Date(now.getTime() - 30 * 60 * 1000).toISOString().replace('T', ' ').replace('Z', '').split('.')[0], // 30 minutes ago
                            number_plate: 'DEF-456'
                        },
                        'sample-004': {
                            date_time: new Date(now.getTime() - 15 * 60 * 1000).toISOString().replace('T', ' ').replace('Z', '').split('.')[0], // 15 minutes ago
                            number_plate: 'GHI-321'
                        }
                    };

                    // Set sample data
                    db.ref('numberplate').set(sampleNumberplateData)
                        .then(() => {
                            console.log('Sample data initialized successfully');
                            console.warn('‚ö†Ô∏è  USING SAMPLE DATA - Timestamps are simulated!');
                            console.warn('‚ö†Ô∏è  Real ESP32 data will automatically replace this sample data.');
                            
                            // Show notification in UI
                            const lastUpdatedEl = document.getElementById('lastUpdated');
                            if (lastUpdatedEl) {
                                const originalText = lastUpdatedEl.textContent;
                                lastUpdatedEl.innerHTML = `<span style="color: orange;">‚ö†Ô∏è Using Sample Data</span> - ${originalText}`;
                                
                                // Remove warning after 10 seconds
                                setTimeout(() => {
                                    lastUpdatedEl.textContent = originalText;
                                }, 10000);
                            }
                        })
                        .catch(error => {
                            console.error('Error initializing sample data:', error);
                        });
                } else {
                    console.log('Real data found, skipping sample data initialization');
                }
            }).catch(error => {
                console.error('Error checking for existing data:', error);
            });
        }

        // Add connection status indicator
        function updateConnectionStatus(status) {
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (!lastUpdatedEl) return;
            
            const statusIndicator = lastUpdatedEl.querySelector('.connection-status') || 
                document.createElement('span');
            statusIndicator.className = `connection-status ${status}`;
            
            if (!lastUpdatedEl.querySelector('.connection-status')) {
                lastUpdatedEl.insertBefore(statusIndicator, lastUpdatedEl.firstChild);
            }
            
            switch(status) {
                case 'connected':
                    lastUpdatedEl.style.color = '#4caf50';
                    break;
                case 'disconnected':
                    lastUpdatedEl.style.color = '#f44336';
                    break;
                case 'connecting':
                    lastUpdatedEl.style.color = '#ff9800';
                    break;
            }
        }

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded, starting application...');
            
            // Initialize DOM elements first
            initializeDOMElements();
            
            // Then initialize the application
            init();
        });
    </script>
</body>
</html>
